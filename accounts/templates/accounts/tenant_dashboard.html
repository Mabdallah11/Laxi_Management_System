<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tenant Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .sidebar {
            width: 250px;
            background-color: #0d6efd;
            color: white;
            padding: 20px;
        }
        .sidebar h3 {
            margin-bottom: 30px;
        }
        .sidebar a {
            display: block;
            padding: 10px;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .sidebar a:hover {
            background-color: #0b5ed7;
        }
        .content {
            flex: 1;
            padding: 30px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h3>Tenant Panel</h3>
        <a href="#">üè† Dashboard</a>
        <a href="{% url 'tenant_service_charges' %}" class="btn btn-info">üí≥ View Service Charges</a>
        <a href="#">üßæ My Invoices</a>
        <a href="{% url 'tenant_add_request' %}">üîß Maintenance</a>

        <a href="{% url 'edit_profile' %}">üë§ Edit Profile</a>
        <a href="{% url 'password_change' %}">üîê Change Password</a>
        <a href="{% url 'logout' %}">üö™ Logout</a>
    </div>

    <!-- Main Content -->
    <div class="content">
        <h2>Welcome, {{ request.user.username }}</h2>
        <p class="text-muted">Here‚Äôs a quick overview of your account.</p>

        <div class="row g-4 mt-3">

    <!-- Card 1: Service Charge Status -->
    <div class="col-md-3">
        <div class="card p-3">
            <h5>Service Charge Status</h5>
            {% if lease %}
                {% if outstanding_balance > 0 %}
                    <p>Outstanding: <strong class="text-danger">‚Ç¶{{ outstanding_balance }}</strong></p>
                    <button class="btn btn-sm btn-primary" onclick="initiatePayment({{ lease.id }})">Pay Now</button>
                {% else %}
                    <p>Status: <strong class="text-success">Paid Up</strong></p>
                    <span class="btn btn-sm btn-success disabled">All Paid</span>
                {% endif %}
            {% else %}
                <p>No lease assigned</p>
                <span class="btn btn-sm btn-secondary disabled">N/A</span>
            {% endif %}
        </div>
    </div>

    <!-- Card 2: Invoices -->
    <div class="col-md-3">
        <a href="#" class="text-decoration-none text-dark">
            <div class="card p-3">
                <h5>Invoices</h5>
                <p>You have <strong>2 pending invoices</strong></p>
                <span class="btn btn-sm btn-secondary">View</span>
            </div>
        </a>
    </div>


    <!-- Card 4: Request New Maintenance -->
    <div class="col-md-3">
        <a href="{% url 'tenant_add_request' %}" class="text-decoration-none text-dark">
            <div class="card p-3">
                <h5>Request Maintenance</h5>
                <p>Have an issue? <strong>Let us know.</strong></p>
                <span class="btn btn-sm btn-success">Request</span>
            </div>
        </a>
    </div>

    <!-- Card 5: General Maintenance Updates -->
    <div class="col-md-3">
        <a href="{% url 'general_maintenance_tenant' %}" class="text-decoration-none text-dark">
            <div class="card p-3">
                <h5>General Maintenance</h5>
                <p>See building-wide repairs & costs</p>
                <span class="btn btn-sm btn-info">View Updates</span>
            </div>
        </a>
    </div>

</div>

    </div>

    <!-- Paystack Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="paymentLoading" class="d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing payment...</p>
                    </div>
                    <div id="paymentForm" class="d-none">
                        <p>Click the button below to complete your payment securely with Paystack.</p>
                        <button id="paystackButton" class="btn btn-primary btn-lg">Pay with Paystack</button>
                    </div>
                    <div id="paymentError" class="d-none">
                        <div class="alert alert-danger">
                            <p id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        let paymentData = null;

        function initiatePayment(leaseId) {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
            
            // Show loading state
            document.getElementById('paymentLoading').classList.remove('d-none');
            document.getElementById('paymentForm').classList.add('d-none');
            document.getElementById('paymentError').classList.add('d-none');
            
            // Fetch payment data
            fetch(`/accounts/payment/initiate/${leaseId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    paymentData = data;
                    showPaymentForm();
                })
                .catch(error => {
                    showError('Failed to initiate payment. Please try again.');
                });
        }

        function showPaymentForm() {
            document.getElementById('paymentLoading').classList.add('d-none');
            document.getElementById('paymentForm').classList.remove('d-none');
            
            // Set up Paystack button
            document.getElementById('paystackButton').onclick = function() {
                const handler = PaystackPop.setup({
                    key: paymentData.public_key,
                    email: paymentData.email,
                    amount: paymentData.amount,
                    ref: paymentData.reference,
                    callback: function(response) {
                        // Verify payment
                        verifyPayment(paymentData.reference);
                    },
                    onClose: function() {
                        alert('Payment cancelled');
                    }
                });
                handler.openIframe();
            };
        }

        function verifyPayment(reference) {
            fetch(`/accounts/payment/verify/${reference}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment successful! You will be redirected to your service charges page.');
                        window.location.href = '/accounts/tenant/service-charges/';
                    } else {
                        showError(data.error || 'Payment verification failed');
                    }
                })
                .catch(error => {
                    showError('Failed to verify payment. Please contact support.');
                });
        }

        function showError(message) {
            document.getElementById('paymentLoading').classList.add('d-none');
            document.getElementById('paymentForm').classList.add('d-none');
            document.getElementById('paymentError').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>
