<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tenant Maintenance Requests</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
  .card-overdue { border: 2px solid #dc3545; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'tenant_dashboard' %}"><i class="fas fa-building me-2"></i>Laxi Management</a>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="nav-link" href="{% url 'tenant_dashboard' %}">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link active" href="{% url 'tenant_add_request' %}">Maintenance</a></li>
      <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
    </ul>
  </div>
</nav>

<div class="container mt-4">

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Analytics Cards -->
  <div class="row mb-4 text-center">
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Total Requests</h6>
          <h3 class="text-primary">{{ requests.count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Pending</h6>
          <h3 class="text-warning">{{ pending_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>In Progress</h6>
          <h3 class="text-info">{{ in_progress_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Completed</h6>
          <h3 class="text-success">{{ completed_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6>Overdue (>30 days)</h6>
          <h3 class="text-danger">{{ overdue_count }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- New Maintenance Request Form -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-edit me-2"></i>New Maintenance Request</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" action="{% url 'tenant_add_request' %}">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Issue Description *</label>
          <textarea name="issue_description" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Priority *</label>
          <select name="priority" class="form-select" required>
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Additional Notes</label>
          <textarea name="additional_notes" class="form-control" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Attachment (photo or file)</label>
          <input type="file" name="attachment" class="form-control" accept="image/*,application/pdf">
          <div class="form-text">You can take/upload a photo from your phone.</div>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-paper-plane me-1"></i>Submit Request
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tenant Maintenance Requests List -->
  <h3 class="mb-3">Your Maintenance Requests</h3>
  {% if requests %}
    <div class="row g-3">
      {% for req in requests %}
        <div class="col-12">
          <div class="card p-3 shadow-sm {% if req.is_overdue %}card-overdue{% endif %}">
            <div class="row g-2">
              <div class="col-md-2 col-4">
                {% if req.attachment %}
                  <img src="{{ req.attachment.url }}" alt="attachment" class="img-fluid rounded" style="max-height:120px; object-fit:cover;">
                {% else %}
                  <div class="border rounded d-flex align-items-center justify-content-center" style="height:120px;">
                    <i class="fas fa-image fa-2x text-muted"></i>
                  </div>
                {% endif %}
              </div>
              <div class="col-md-10 col-8">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="mb-1">{{ req.request_id }} â€” {{ req.issue_description|truncatechars:80 }}</h6>
                    <p class="mb-1 text-muted">{{ req.additional_notes|default:"" }}</p>
                    <small class="text-muted">Created: {{ req.date_created|date:"M d, Y H:i" }}</small>
                  </div>
                  <div class="text-end">
                    <p class="mb-1">
                      {% if req.priority == 'high' %}
                        <span class="badge bg-danger">High</span>
                      {% elif req.priority == 'medium' %}
                        <span class="badge bg-warning text-dark">Medium</span>
                      {% else %}
                        <span class="badge bg-secondary">Low</span>
                      {% endif %}
                    </p>
                    <p class="mb-0">
                      {% if req.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                      {% elif req.status == 'in_progress' %}
                        <span class="badge bg-info text-dark">In Progress</span>
                      {% else %}
                        <span class="badge bg-secondary">Pending</span>
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">You have no maintenance requests yet.</p>
  {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
